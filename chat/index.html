<html>
	<body onload="ready()">
		<h2>CHAT</h2>

		<ul id="chat"></ul>
    
    <label>Enter your name</label><input id="username" />
    <hr/>

    <form id="chatForm">
      <input id="chatInput" />
      <button>Send</button>
    </form>
    
		<script src="../gun.js"></script>
    
		<script>
		function ready(){
			var $ = document.querySelector.bind(document);
			var gun = Gun(location.origin + '/gun').load('example/chat/data').set({});
			
      gun.on(function renderChat(val){
				var chatHTML = '';
        
				for(key in val) {
					if(!val[key] || key == '_') continue;
          console.log(val[key]["text"]);
					chatHTML += '<li style="width:400px;height:2em;">' +
          (val[key]||'').toString().replace(/\</ig, '&lt;') + '</li>';
				}
        
				$("#chat").innerHTML = chatHTML;
			});
      
			$("#chatForm").onsubmit = function(){
				var id = randomId();
				gun.path(id).set({
				  "name": ($("#username").value||'noname').toString().replace(/\</ig, '&lt;'),
          "text": ($("#chatInput").value||'').toString().replace(/\</ig, '&lt;')
				});
        
				$("#chatInput").value = "";
				return false;
			};
		}
    
		function randomId(){
			return ''+(new Date()).getTime()+Math.round((Math.random()*1000));
		}
		</script>
	</body>
</html>
